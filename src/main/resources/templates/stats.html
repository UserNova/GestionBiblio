<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Statistiques</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.2/dist/minty/bootstrap.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-light">
<div th:replace="fragments/navbar :: navbar"></div>
<div class="container py-4">
    <h1 class="mb-4">Statistiques</h1>

    <form class="row g-2 mb-4" method="get" th:action="@{/stats}">
        <div class="col-md-3">
            <input id="startInput" class="form-control" type="date" name="start" th:value="${start}" />
        </div>
        <div class="col-md-3">
            <input id="endInput" class="form-control" type="date" name="end" th:value="${end}" />
        </div>
        <div class="col-md-3">
            <input id="limitInput" class="form-control" type="number" min="1" name="limit" th:value="${limit}" placeholder="Top auteurs (N)" />
        </div>
        <div class="col-md-3 d-grid">
            <button class="btn btn-primary" type="submit">Actualiser</button>
        </div>
    </form>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Total emprunts</h5>
                    <p class="display-6" th:text="${totalEmprunts}">0</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Emprunts par mois</h5>
                    <canvas id="chartEmpruntsMois" height="220"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Top auteurs</h5>
                    <canvas id="chartTopAuteurs" height="220"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Emprunts par cat√©gorie</h5>
                    <canvas id="chartCategories" height="220"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Emprunts par statut</h5>
                    <canvas id="chartStatus" height="220"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mt-1">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Retards par mois</h5>
                    <canvas id="chartRetardsMois" height="240"></canvas>
                </div>
            </div>
        </div>
    </div>

</div>

<script th:inline="javascript">
    const parMois = /*[[${parMois}]]*/ [];
    const topAuteurs = /*[[${topAuteurs}]]*/ [];
    const parCategorie = /*[[${parCategorie}]]*/ [];
    const parStatut = /*[[${parStatut}]]*/ [];
    const retardsParMois = /*[[${retardsParMois}]]*/ [];

    const moisLabels = parMois.map(x => x.month);
    const moisTotals = parMois.map(x => x.total);

    const auteursLabels = topAuteurs.map(x => x.nom);
    const auteursTotals = topAuteurs.map(x => x.total);

    const catLabels = parCategorie.map(x => x.categorie || 'Inconnue');
    const catTotals = parCategorie.map(x => x.total);

    const statutLabels = parStatut.map(x => x.statut || 'Inconnu');
    const statutTotals = parStatut.map(x => x.total);

    const retLabels = retardsParMois.map(x => x.month);
    const retOverdue = retardsParMois.map(x => x.overdue);
    const retTotals = retardsParMois.map(x => x.total);

    const palette = ['#0d6efd','#6610f2','#6f42c1','#d63384','#dc3545','#fd7e14','#ffc107','#198754','#20c997','#0dcaf0','#6c757d'];

    new Chart(document.getElementById('chartEmpruntsMois'), {
        type: 'bar',
        data: { labels: moisLabels, datasets: [{ label: 'Emprunts', data: moisTotals, backgroundColor: '#0d6efd66', borderColor: '#0d6efd' }]},
        options: { responsive: true, plugins: { legend: { display: false } } }
    });

    new Chart(document.getElementById('chartTopAuteurs'), {
        type: 'bar',
        data: { labels: auteursLabels, datasets: [{ label: 'Emprunts', data: auteursTotals, backgroundColor: '#19875466', borderColor: '#198754' }]},
        options: { responsive: true, indexAxis: 'y' }
    });

    new Chart(document.getElementById('chartCategories'), {
        type: 'pie',
        data: { labels: catLabels, datasets: [{ data: catTotals, backgroundColor: catLabels.map((_,i)=> palette[i%palette.length]) }]},
        options: { responsive: true }
    });

    new Chart(document.getElementById('chartStatus'), {
        type: 'doughnut',
        data: { labels: statutLabels, datasets: [{ data: statutTotals, backgroundColor: statutLabels.map((_,i)=> palette[(i+3)%palette.length]) }]},
        options: { responsive: true }
    });

    new Chart(document.getElementById('chartRetardsMois'), {
        type: 'bar',
        data: { labels: retLabels, datasets: [
            { label: 'Retards', data: retOverdue, backgroundColor: '#dc354566', borderColor: '#dc3545' },
            { label: 'Total', data: retTotals, backgroundColor: '#6c757d66', borderColor: '#6c757d' }
        ]},
        options: { responsive: true }
    });
</script>
</body>
</html>


